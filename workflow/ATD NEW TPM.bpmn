<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
  typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath"
  targetNamespace="http://www.activiti.org/test">
  <process id="ATD NEW TPM" name="ATD NEW TPM" isExecutable="true">
  
  	<startEvent id="startWorkflow" name="Start"/> 
    
    <sequenceFlow id="getPIDAndNowString" sourceRef="startWorkflow" targetRef="Get PID and Now String"/>
    
    <serviceTask id="Get PID and Now String" name="Set PID and Date Now" activiti:class="com.reallysi.rsuite.system.workflow.actions.SetDynamicValuesToVariablesActionHandler">
      <activiti:field name="variableNames" stringValue="pId;nowString"/>
      <activiti:field name="pId;nowString" stringValue="pId;nowString"/>
    </serviceTask>
  
    <sequenceFlow id="fromGetPIDToSetVariablesFromProperties" sourceRef="Get PID and Now String" targetRef="Set Variables From Properties"></sequenceFlow>
      
    <serviceTask id="Set Variables From Properties" name="Set Base Export Folders" activiti:class="com.reallysi.rsuite.system.workflow.actions.SetGlobalVariablesActionHandler">
      <activiti:field name="variableNames" stringValue="exportDir;sharedExportDir"/>
      <activiti:field name="values" stringValue="${astd.base.export.dir}${astd.xml.export.dir}/${pId};${astd.export.share}${astd.xml.export.dir}/${pId}"/>
    </serviceTask>

    <sequenceFlow id="fromSetVariablesTo" sourceRef="Set Variables From Properties" targetRef="XML to INCX"></sequenceFlow>
    
    <serviceTask id="Validate File Name" name="Validate File Parameters" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.AtdValidateFileNameActionHandler">
      <activiti:field name="allowedExtension" stringValue=".docx"/>
      <activiti:field name="errorIfLocked" stringValue="true"/>
      <activiti:field name="extensionErrorMessage" stringValue="Only MS Word 2007 or later allowed. Please open in MS Word 2007 and save as a .docx file."/>
    </serviceTask>
    
    <sequenceFlow id="flowToLoadErrorDecision" sourceRef="Validate File Name" targetRef="loadErrorGateway"></sequenceFlow>
    
    <exclusiveGateway id="loadErrorGateway" name="Load Error?"></exclusiveGateway>
    
    <sequenceFlow id="Are there validation errors?" sourceRef="Validate File Name" targetRef="Validation Error Alert">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${VALIDATION_MSGS == null}]]></conditionExpression>
    </sequenceFlow>
    
    <userTask id="Validation Error Alert" name="TPM Error Alert: Article Worfklow: Docx Load Failed" activiti:assignee="${rsuiteUserId}" activiti:candidateGroups="Managing Editor">
      <documentation>${VALIDATION_MSGS}</documentation>
    </userTask>
    
    <!-- This should transition to Load DOCX. See old workflow definition. -->
    <sequenceFlow id="flowToLoadDocx" sourceRef="loadErrorGateway" targetRef="XML to INCX">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR != null}]]></conditionExpression>
    </sequenceFlow>
    
    <sequenceFlow id="flowFromValidationErrorToEnd" sourceRef="Validation Error Alert" targetRef="endWorkflow"></sequenceFlow>  
     

    <serviceTask id="XML to INCX" name="Ensure Map" activiti:class="com.astd.rsuite.actions.AstdXml2IncxActionHandler">
      <activiti:field name="styleCatalogUri" stringValue="rsuite:/res/plugin/astd/xslt/newtpm2indesign/tpm-dita-indesign-style-catalog.xml"/>
      <activiti:field name="xsltUri" stringValue="${sourceFileName}"/>
      <activiti:field name="fileName" stringValue="rsuite:/res/plugin/astd/xslt/newtpm2indesign/tpmArticle2InDesign.xsl"/>
      <activiti:field name="xmlMoId" stringValue="${xmlMoId}"/>
    </serviceTask>
        
    <userTask id="Review Proofs" name="Review Proofs" activiti:assignee="${rsuiteUserId}" activiti:candidateGroups="Associate Editor">
      <documentation>"Document: ${VALIDATION_MSGS}.incx"</documentation>
    </userTask>
    
    <!-- Link this task from the node Begin Design Task-->
    <sequenceFlow id="flowToSetNoDetailChanges" sourceRef="Review Proofs" targetRef="Set No detail changes"></sequenceFlow>  
        
    <serviceTask id="Set No detail changes" name="Set No detail changes" activiti:class="com.reallysi.rsuite.system.workflow.actions.SetGlobalVariablesActionHandler">
      <activiti:field name="variableNames" stringValue="detail"/>
      <activiti:field name="values" stringValue="no text changes"/>
    </serviceTask>
  

    
    <sequenceFlow id="LoadINX" sourceRef="Have No Exec Summary?" targetRef="Have No Exec Summary?"></sequenceFlow>
    <serviceTask id="Load INX" name="Load INX" activiti:class="com.reallysi.rsuite.system.workflow.actions.LoadNonXmlByAliasActionHandler">
      <activiti:field name="alias" stringValue="${sourceFileName}.incx"/>
      <activiti:field name="commitMessage" stringValue="Loaded by workflow"/>
      <activiti:field name="parentMoId" stringValue="${articleCaId}"/>
    </serviceTask>
        

  
    <sequenceFlow id="fromServiceTaskToEndWorkflow" sourceRef="Set Variables From Properties" targetRef="endWorkflow"></sequenceFlow>
    <endEvent id="endWorkflow" name="End Workflow"></endEvent>
    <dataObject id="EXCEPTION_OCCUR" name="EXCEPTION_OCCUR" itemSubjectRef="xsd:string">
      <extensionElements>
        <activiti:value>""</activiti:value>
      </extensionElements>
    </dataObject>
    <dataObject id="rsuiteUserId" name="rsuiteUserId" itemSubjectRef="xsd:string"></dataObject>
  </process>
  
</definitions>