<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
  typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath"
  targetNamespace="http://www.activiti.org/test">
  <process id="ATD NEW TPM" name="ATD NEW TPM" isExecutable="true">
  
  	<startEvent id="startWorkflow" name="Start"/> 
    
    <sequenceFlow id="getPIDAndNowString" sourceRef="startWorkflow" targetRef="Get PID and Now String"/>
    
    <serviceTask id="Get PID and Now String" name="Set PID and Date Now" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetDynamicValuesToVariablesActionHandler">
      <activiti:field name="variableNames" stringValue="pId;nowString"/>
      <activiti:field name="items" stringValue="pId;nowString"/>
    </serviceTask>
      
    <sequenceFlow id="LoadINX" sourceRef="Get PID and Now String" targetRef="SetVariablesFromProperties"></sequenceFlow>
    
  <!--	<sequenceFlow id="flowToLoadErrorDecision" sourceRef="generateReport" targetRef="loadErrorGateway"></sequenceFlow> -->
    
    <exclusiveGateway id="determineExecSummary" name="Have No Exec Summary?"></exclusiveGateway>
    
    <sequenceFlow id="flowToLoadExecSummary" sourceRef="determineExecSummary" targetRef="loadExecSummary">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[$!{empty incxExecSummaryFile}]]></conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="flowToMakeArticleCACurrent" sourceRef="determineExecSummary" targetRef="makeArticleCACurrent">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${empty incxExecSummaryFile}]]></conditionExpression>
    </sequenceFlow>
    
   
    <serviceTask id="loadInx" name="Load INX" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectLoadNonXmlByAliasHandler">
      <activiti:field name="alias" expression="${sourceFileName}.incx"/>
      <activiti:field name="commitMessage" stringValue="Loaded by workflow"/>
      <activiti:field name="parentMoId" expression="${articleCaId}"/>
    </serviceTask>
    
      
    <serviceTask id="SetVariablesFromProperties" name="Ensure Map" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetGlobalVariablesActionHandler">
      <activiti:field name="variableNames" stringValue="exportDir;sharedExportDir"/>
      <activiti:field name="values" stringValue="${astd.base.export.dir}${astd.xml.export.dir}/${pId};${astd.export.share}${astd.xml.export.dir}/${pId}"/>
    </serviceTask>

    <sequenceFlow id="fromSetVariablesToValidateFileName" sourceRef="SetVariablesFromProperties" targetRef="Validate File Name"></sequenceFlow>
    
    <serviceTask id="Validate File Name" name="Validate File Parameters" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.AtdValidateFileNameActionHandler">
      <activiti:field name="allowedExtension" stringValue=".docx"/>
      <activiti:field name="errorIfLocked" stringValue="true"/>
      <activiti:field name="extensionErrorMessage" stringValue="Only MS Word 2007 or later allowed. Please open in MS Word 2007 and save as a .docx file."/>
      <activiti:field name="errorIfExits" stringValue="true"/>
    </serviceTask>
    
    <sequenceFlow id="flowToLoadErrorDecision" sourceRef="Validate File Name" targetRef="loadErrorGateway"></sequenceFlow>
    
    <exclusiveGateway id="loadErrorGateway" name="Load Error?"></exclusiveGateway>
    
    <sequenceFlow id="flowToLoadDocx" sourceRef="loadErrorGateway" targetRef="loadDOCX">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${VALIDATION_MSGS == null}]]></conditionExpression>
    </sequenceFlow>
    
    <sequenceFlow id="flowToValidationError" sourceRef="loadErrorGateway" targetRef="Validation Error Alert">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${VALIDATION_MSGS != null}]]></conditionExpression>
    </sequenceFlow>
    
    
    <userTask id="Validation Error Alert" name="TPM Error Alert: Article Worfklow: Docx Load Failed" activiti:assignee="${rsuiteUserId}" activiti:candidateGroups="Managing Editor">
      <documentation>${VALIDATION_MSGS}</documentation>
    </userTask>
    

    <serviceTask id="loadDOCX" name="Load DOCX" activiti:class="org.astd.rsuite.workflow.actions.LoadActionHandler">
      <activiti:field name="regex" stringValue=""/>
      <activiti:field name="xmlMoMatchExpressions" stringValue=""/>
      <activiti:field name="layeredMetadataMatchExpressions" stringValue=""/>
      <activiti:field name="moChunkMatchExpressions" stringValue=""/>
      <activiti:field name="collection" stringValue=""/>
      <activiti:field name="inputFolder" stringValue=""/>
      <activiti:field name="notDelete" stringValue=""/>
      <activiti:field name="creationPolicy" stringValue="UpdateRepository"/>
      <activiti:field name="commitMessage" stringValue="Loaded via workflow"/>
      <activiti:field name="alwaysTreatAsXml" stringValue=""/>
      <activiti:field name="neverTreatAsXml" stringValue=""/>
    </serviceTask>

	<sequenceFlow id="flowFromLoadDocxToValidationError" sourceRef="loadDOCX" targetRef="docxLoadFailed?"></sequenceFlow>  
    
    <sequenceFlow id="flowFromValidationErrorToEnd" sourceRef="Validation Error Alert" targetRef="endWorkflow"></sequenceFlow>  
     

    <serviceTask id="xMLToINCX" name="XML to INCX" activiti:class="org.astd.rsuite.workflow.actions.AstdXml2IncxActionHandler">
      <activiti:field name="styleCatalogUri" stringValue="rsuite:/res/plugin/astd/xslt/newtpm2indesign/tpm-dita-indesign-style-catalog.xml"/>
      <activiti:field name="xsltUriFromWorkflow" stringValue="${sourceFileName}"/>
      <activiti:field name="fileName" stringValue="rsuite:/res/plugin/astd/xslt/newtpm2indesign/tpmArticle2InDesign.xsl"/>
      <activiti:field name="xmlMoId" stringValue="${xmlMoId}"/>
    </serviceTask>


    <userTask id="Begin Design Task" name="Begin Design Task" activiti:assignee="${rsuiteUserId}" activiti:candidateGroups="Art Director">
      <documentation>"Document: ${VALIDATION_MSGS}.incx"</documentation>
    </userTask>

    <sequenceFlow id="flowReviewProofs" sourceRef="Begin Design Task" targetRef="Review Proofs"></sequenceFlow>

        
    <userTask id="Review Proofs" name="Review Proofs" activiti:assignee="${rsuiteUserId}" activiti:candidateGroups="Associate Editor">
      <documentation>"Document: ${VALIDATION_MSGS}.incx"</documentation>
    </userTask>
    
    <!-- Link this task from the node Begin Design Task-->
    <sequenceFlow id="flowToSetNoDetailChanges" sourceRef="Review Proofs" targetRef="Set No detail changes"></sequenceFlow>  
        
    <serviceTask id="Set No detail changes" name="Set No detail changes" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetGlobalVariablesActionHandler">
      <activiti:field name="variableNames" stringValue="detail"/>
      <activiti:field name="values" stringValue="no text changes"/>
    </serviceTask>
      
    <serviceTask id="loadExecSummary" name="Load Exec Summary" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectLoadNonXmlByAliasHandler">
      <activiti:field name="alias" stringValue="${incxExecSummaryFile}"/>
      <activiti:field name="fileToLoadFromWorkflow" stringValue="${incxExecSummaryPath}"/>
      <activiti:field name="commitMessageFromWorkflow" expression="Generated by ${rsuiteUserId} via workflow"/>
      <activiti:field name="parentMoIdFromWorkflow" stringValue="${articleCaMoId}"/>
    </serviceTask>
  
    <serviceTask id="setArticleLM" name="Set Article LM" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectAddLayeredMetadataActionHandler">
      <activiti:field name="metadataName" stringValue="ca-type;article-process-id"/>
      <activiti:field name="metadataValue" stringValue="article;${pId}"/>
      <activiti:field name="moList" stringValue="${articleCaMoId}"/>
    </serviceTask>
    
    <serviceTask id="makeArticleCACurrent" name="Make Article CA Current" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetWorkflowMoListFromVariableHandler">
      <activiti:field name="moSpecifyingVariableName" stringValue="articleCaMoId"/>
    </serviceTask>
    
    
    <serviceTask id="makeXMLCurrent" name="Make XML Current" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetWorkflowMoListFromVariableHandler">
      <activiti:field name="moSpecifyingVariableName" stringValue="xmlMoId"/>
    </serviceTask>
    
    <serviceTask id="clearHTMLExportStatus" name="Clear HTML Export Status" activiti:class="com.reallysi.rsuite.system.workflow.actions.ClearExceptionStatus">
    </serviceTask>
    
    <sequenceFlow id="fromToClearExceptionToRestoArticle" sourceRef="clearHTMLExportStatus" targetRef="restoreArticleCAAfterExports"></sequenceFlow>
    
    <serviceTask id="restoreArticleCAAfterExports" name="Restore Article CA After Exports" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetWorkflowMoListFromVariableHandler">
      <activiti:field name="moSpecifyingVariableName" stringValue="articleCaMoId"/>
    </serviceTask>
    
    
    <callActivity id="ExportArticleHTML" calledElement="ATD Export Article HTML" >
  		<extensionElements>
	  		<activiti:in source="rsuite contents" target="rsuite contents" />
	  		<activiti:in source="articleCaMoId" target="parentMoId" />
  		</extensionElements>
	</callActivity>
	
	<sequenceFlow id="flowToClearHtmlExportStatus" sourceRef="ExportArticleHTML" targetRef="clearHTMLExportStatus" />
    
    <serviceTask id="clearLoadDitaStatus" name="Clear Load Dita Status" activiti:class="com.reallysi.rsuite.system.workflow.actions.ClearExceptionStatus">
    </serviceTask>
    
    
    <serviceTask id="docX2XMLTransform" name="DocX2XML Transform" activiti:class="org.dita4publishers.rsuite.workflow.actions.Docx2XmlActionHandler">
      <activiti:field name="styleMapUri" stringValue="rsuite:/res/plugin/astd/xslt/word2xml/article-style2tagmap.xml"/>
      <activiti:field name="xsltUri" stringValue="rsuite:/res/plugin/astd/xslt/word2xml/docx2article.xsl"/>
      <activiti:field name="outputPath" stringValue="${exportDir}"/>
      <activiti:field name="resultFileName" stringValue="${sourceFileName}"/>
      <activiti:field name="docxMoId" stringValue="${docxMoId}"/>
    </serviceTask>
    
    
    <sequenceFlow id="fromdocX2XMLTransformToDecision" sourceRef="docX2XMLTransform" targetRef="determineDocx2XmlError"></sequenceFlow>
     
    <exclusiveGateway id="determineDocx2XmlError" name="DOCX2XML Error ?"></exclusiveGateway>
    
    <sequenceFlow id="flowToDOCX2XMLError" sourceRef="determineDocx2XmlError" targetRef="docx2XmlError">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[$!{EXCEPTION_OCCUR==true}]]></conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="flowToImportDITA" sourceRef="determineDocx2XmlError" targetRef="importDITA">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==false}]]></conditionExpression>
    </sequenceFlow>
    
    
    <userTask id="loadDITAFailed" name="TPM Error Alert: Article Workflow: XML Load Failed" activiti:assignee="${rsuiteUserId}" activiti:candidateGroups="Managing Editor">
      <documentation>"Load of DITA XML from DOCX #{fullFileName} failed: #{exceptionMessage}&lt;br/&gt;File also exported to #{sharedExportDir} 
      		&lt;br/&gt;See validation report &lt;a href='/rsuite/rest/v1/report/generated/#{validationReportId}?skey=RSUITE-SESSION-KEY' target='_xformReport'&gt;#{validationReportFileName}&lt;a/&gt;"</documentation>
    </userTask>
    
    <userTask id="docx2XmlError" name="Error Alert: Article Workflow: Word to XML Failed" activiti:assignee="${rsuiteUserId}" activiti:candidateGroups="Managing Editor">
      <documentation>"#{moDisplayName}: Generation of XML from DOCX failed: #{exceptionMessage} 
      	&lt;br/&gt;See conversion report &lt;a href='/rsuite/rest/v1/report/generated/#{xformReportId}?skey=RSUITE-SESSION-KEY'  target='_xformReport'&gt;#{xformReportFileName}&lt;a/&gt;"></documentation>
    </userTask>
    
    <sequenceFlow id="fromDocx2XmlErrorToClearDitaStatus" sourceRef="docx2XmlError" targetRef="clearLoadDitaStatus"></sequenceFlow>
    
    <sequenceFlow id="fromLoadDITAFailedToClearDitaStatus" sourceRef="loadDITAFailed" targetRef="clearLoadDitaStatus"></sequenceFlow>
    
    
    <userTask id="finalEditTask" name="Final Edit Task" activiti:assignee="${rsuiteUserId}" activiti:candidateGroups="Associate Editor">
      <documentation>"Document: # {fullFileName}"</documentation>
    </userTask>
    
    <sequenceFlow id="fromFinalEditTaskToGetTax" sourceRef="finalEditTask" targetRef="getTax"></sequenceFlow>
    
    <serviceTask id="getTax" name="Get Tax" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectAtdSetClassificationVarActionHandler">
      <activiti:field name="moAlias" stringValue="${sourceFileName}.xml"/>
      <activiti:field name="targetVariableName" stringValue="articleClassification"/>
    </serviceTask>         
    
    <sequenceFlow id="fromServiceTaskToEndWorkflow" sourceRef="SetVariablesFromProperties" targetRef="endWorkflow"></sequenceFlow>
    
    <serviceTask id="importDITA" name="Import DITA" activiti:class="com.reallysi.rsuite.workflow.actions.TopicImporterActionHandler">
      <activiti:field name="topicPath" stringValue="${articleCaMoId}"/>
      <activiti:field name="parentCaId" stringValue="rsuite:/res/plugin/astd/xslt/word2xml/docx2article.xsl"/>
      <activiti:field name="commitMessage" stringValue="Loaded via workflow from hotfolder"/>
      <activiti:field name="importedMoListVarname" stringValue="xmlMoId"/>
      <activiti:field name="topicContainerName" stringValue="media"/>
    </serviceTask>
    
    <exclusiveGateway id="setTaxFailed?" name="Set Tax Failed?"></exclusiveGateway>
    
    <sequenceFlow id="flowToLoadDITAFailed" sourceRef="setTaxFailed?" targetRef="loadDITAFailed">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[$!{EXCEPTION_OCCUR==true}]]></conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="flowToXMLToINCX" sourceRef="setTaxFailed?" targetRef="xMLToINCX">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==false}]]></conditionExpression>
    </sequenceFlow>
    
    
    <serviceTask id="captureDOCXMOID" name="Capture DOCX MO ID" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetVariableFromMoWorkflowListHandler">
      <activiti:field name="targetVariableName" stringValue="docxMoId"/>
    </serviceTask>
    
     <serviceTask id="captureArticleCAMOID" name="Capture Article CA MO ID" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetVariableFromMoWorkflowListHandler">
      <activiti:field name="targetVariableName" stringValue="articleCaMoId"/>
    </serviceTask>
    
    <sequenceFlow id="flowToSetArticleLM" sourceRef="captureArticleCAMOID" targetRef="setArticleLM"></sequenceFlow>
    
    <sequenceFlow id="fromCaptureDOCXMOIDToDecisionNode" sourceRef="captureDOCXMOID" targetRef="isUnknownDOCX?"></sequenceFlow>
    
    <exclusiveGateway id="isUnknownDOCX?" name="Is Unknown DOCX?"></exclusiveGateway>
    
    <!-- TODO: Link these two transitions to the handlers being implemented by Sudheer -->
    
    <sequenceFlow id="flowFromUnknownDOCXToLoadDitaFailed" sourceRef="isUnknownDOCX?" targetRef="loadDITAFailed">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[$!{volumeNumber=='99'}]]></conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="flowFromUnknownDOCXToXmlToIncx" sourceRef="isUnknownDOCX?" targetRef="xMLToINCX">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${volumeNumber!='99'}]]></conditionExpression>
    </sequenceFlow>

    <exclusiveGateway id="docxLoadFailed?" name="DOCX Load Failed?"></exclusiveGateway>
        
    <sequenceFlow id="flowToCreateCAsForUnknownDOCX" sourceRef="docxLoadFailed?" targetRef="docxLoadError">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR=='true'}]]></conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="flowFromDocxFailedToCaptureDocxMOID" sourceRef="docxLoadFailed?" targetRef="captureDOCXMOID">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR=='false'}]]></conditionExpression>
    </sequenceFlow>
    
    <userTask id="docxLoadError" name="TPM Error Alert: Article Workflow: Docx Load Failed" activiti:assignee="${rsuiteUserId}" activiti:candidateGroups="Managing Editor">
      <documentation>"Load of file #{fullFileName} failed: #{exceptionMessage}"</documentation>
    </userTask>
    
    <sequenceFlow id="fromDocxLoadErrorToEndWorkflow" sourceRef="docxLoadError" targetRef="endWorkflow"></sequenceFlow>      

    <endEvent id="endWorkflow" name="End Workflow"></endEvent>
    <dataObject id="EXCEPTION_OCCUR" name="EXCEPTION_OCCUR" itemSubjectRef="xsd:string">
      <extensionElements>
        <activiti:value>""</activiti:value>
      </extensionElements>
    </dataObject>
    <dataObject id="rsuiteUserId" name="rsuiteUserId" itemSubjectRef="xsd:string"></dataObject>
  </process>
   
</definitions>