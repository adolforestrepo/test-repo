<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"
	xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
	xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
	typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath"
	targetNamespace="http://www.activiti.org/test">
	<process id="ATD Docx to XML" name="ATD Docx to XML" isExecutable="true">

	<startEvent id="startWorkflow" name="Start" />

    <sequenceFlow id="flowToSetParentCANodetoVariable" sourceRef="startWorkflow" targetRef="setParentCANodetoVariable"/>

    <serviceTask id="setParentCANodetoVariable" name="Set Parent CA Node to Variable" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetParentBrowseTreeNodeToVariableHandler">
      <activiti:field name="variableName" stringValue="parentMoId"/>
    </serviceTask>

    <sequenceFlow id="flowFromSetParentCAToSetVariables" sourceRef="setParentCANodetoVariable" targetRef="setVariablesfromProperties"/>
    
    <serviceTask id="setVariablesfromProperties" name="Set Variables from Properties" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetGlobalVariablesActionHandler">
      <activiti:field name="variableNames" stringValue="exportDir;sharedExportDir" />
      <activiti:field name="values" stringValue="${astd.base.export.dir}${astd.xml.export.dir}/${rsuiteUserId};${astd.export.share}${astd.xml.export.dir}/${rsuiteUserId}" />
    </serviceTask>

    <sequenceFlow id="flowFromSetVariablesToSetMODetails" sourceRef="setVariablesfromProperties" targetRef="setMODetailstoVariables"/>
    
    <serviceTask id="setMODetailstoVariables" name="Set MO Details to Variables" activiti:class="com.reallysi.rsuite.system.workflow.actions.SetVariablesFromMoDetails">
    </serviceTask>

    <sequenceFlow id="flowFromSetMODetailsToDOCXtoDITA" sourceRef="setMODetailstoVariables" targetRef="dOCXtoDITAXML"/>
    
    <serviceTask id="dOCXtoDITAXML" name="DOCX to DITA XML" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectAstdDocxToXmlActionHandler">
      <activiti:field name="styleMapUri" stringValue="rsuite:/res/plugin/astd-plugin/xslt/word2xml/article-style2tagmap.xml" />
      <activiti:field name="xsltUri" stringValue="rsuite:/res/plugin/astd-plugin/xslt/word2xml/docx2article.xsl" />
      <activiti:field name="outputPath" stringValue="${exportDir}" />
      <activiti:field name="resultFileName" stringValue="${moBaseName}.xml" />
<<<<<<< HEAD
=======
      <activiti:field name="docxMoId" stringValue="${rsuite contents}" />
      <activiti:field name="xsltGraphicRenameUri" stringValue="" />
      <activiti:field name="graphicsPrefix" stringValue="" />
>>>>>>> 7085334cf63a56c9145c19a141272f39cf2d02b0
    </serviceTask>
    <sequenceFlow id="fromDOCXtoDITAToDecision" sourceRef="dOCXtoDITAXML" targetRef="determineDocx2XmlExceptionOccur"/>

	<exclusiveGateway id="determineDocx2XmlExceptionOccur" name="Exception Occur?"></exclusiveGateway>

	<sequenceFlow id="flowToDOCX2XMLError" sourceRef="determineDocx2XmlExceptionOccur" targetRef="xMLGenerationFailed">
		<conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==true}]]></conditionExpression>
	</sequenceFlow>

	<sequenceFlow id="flowToImportDITA" sourceRef="determineDocx2XmlExceptionOccur" targetRef="importDITA">
		<conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==false}]]></conditionExpression>
	</sequenceFlow>

	<userTask id="xMLGenerationFailed" name="XML Generation Failed" activiti:assignee="${rsuiteUserId}" activiti:candidateGroups="RSuiteAdministrator">
	  <documentation>"#{moDisplayName}: Generation of XML from DOCX failed: #{exceptionMessage} &lt;br/&gt;See conversion report &lt;a href='/rsuite/rest/v1/report/generated/#{xformReportId}?skey=RSUITE-SESSION-KEY' target='_xformReport'&gt;#{xformReportFileName}&lt;a/&gt;"</documentation>
	  <extensionElements>
	    <activiti:taskListener event="create" class="com.reallysi.rsuite.system.workflow.actions.taskcreate.AssignTaskToUserFromVariable"></activiti:taskListener>
	  </extensionElements>
	</userTask>

	<sequenceFlow id="fromxMLGenerationFailedtoendWorkflow" sourceRef="xMLGenerationFailed" targetRef="endWorkflow"/>
	<sequenceFlow id="fromxMLGenerationFailedtoClearExceptionStatus" sourceRef="xMLGenerationFailed" targetRef="ClearExceptionStatus"/>
    
    <serviceTask id="importDITA" name="Import DITA" activiti:class="com.reallysi.rsuite.workflow.actions.TopicImporterActionHandler">
                <activiti:field name="topicPath" stringValue="${exportDir}/${sourceFileName}/${sourceFileName}.xml" />
                <activiti:field name="parentCaId" stringValue="${parentMoId}" />
                <activiti:field name="commitMessage" stringValue="Regenerated by ${rsuiteUserId}" />
                <activiti:field name="topicContainerName" stringValue="media" />
    </serviceTask>

    <sequenceFlow id="fromImportDitaToSetTax" sourceRef="importDITA" targetRef="DetermineLoadTheXmlFailed"></sequenceFlow>
    
	<exclusiveGateway id="DetermineLoadTheXmlFailed" name="Load Failed?"></exclusiveGateway>

	<sequenceFlow id="flowToLoadTheXmlError" sourceRef="DetermineLoadTheXmlFailed" targetRef="LoadofXMLFailed">
		<conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==true}]]></conditionExpression>
	</sequenceFlow>

	<sequenceFlow id="flowxmlGenerated" sourceRef="DetermineLoadTheXmlFailed" targetRef="XMLGenerated">
		<conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==false}]]></conditionExpression>
	</sequenceFlow>
	
	<userTask id="LoadofXMLFailed" name="Load of XML Failed">
	  <documentation>"#{moDisplayName}: Load of generated XML  failed: #{exceptionMessage} &lt;br/&gt;File also exported to #{sharedExportDir} &lt;br/&gt;See conversion report &lt;a href='/rsuite/rest/v1/report/generated/#{xformReportId}?skey=RSUITE-SESSION-KEY'       target='_xformReport'&gt;#{xformReportFileName}&lt;a/&gt;"</documentation>
	  <extensionElements>
	    <activiti:taskListener event="create" class="com.reallysi.rsuite.system.workflow.actions.taskcreate.AssignTaskToUserFromVariable"></activiti:taskListener>
	  </extensionElements>
	</userTask>
	
	<sequenceFlow id="fromLoadofXMLFailedtoendWorkflow" sourceRef="LoadofXMLFailed" targetRef="endWorkflow"/>
	<sequenceFlow id="fromLoadofXMLFailedtoClearExceptionStatus" sourceRef="LoadofXMLFailed" targetRef="ClearExceptionStatus"/>
	
	<userTask id="XMLGenerated" name="XML Generated">
	  <documentation>"#{moDisplayName}: XML generated and updated in RSuite. &lt;br/&gt;File also exported to #{sharedExportDir} &lt;br/&gt;See conversion report &lt;a href='/rsuite/rest/v1/report/generated/#{xformReportId}?skey=RSUITE-SESSION-KEY'       target='_xformReport'&gt;#{xformReportFileName}&lt;a/&gt;"</documentation>
	  <extensionElements>
	    <activiti:taskListener event="create" class="com.reallysi.rsuite.system.workflow.actions.taskcreate.AssignTaskToUserFromVariable"></activiti:taskListener>
	  </extensionElements>
	</userTask>
	
	<sequenceFlow id="fromXMLGeneratedtoendWorkflow" sourceRef="XMLGenerated" targetRef="endWorkflow"/>
	
    <serviceTask id="ClearExceptionStatus" name="Clear Exception Status" activiti:class="com.reallysi.rsuite.system.workflow.actions.ClearExceptionStatus">
    </serviceTask>

    <sequenceFlow id="flowFromClearExceptionStatusToDOCXtoDITA" sourceRef="ClearExceptionStatus" targetRef="dOCXtoDITAXML"/>

    <endEvent id="endWorkflow" name="End Workflow"></endEvent>

    <dataObject id="EXCEPTION_OCCUR" name="EXCEPTION_OCCUR" itemSubjectRef="xsd:string">
      <extensionElements>
        <activiti:value>""</activiti:value>
      </extensionElements>
    </dataObject>
    <dataObject id="rsuiteUserId" name="rsuiteUserId" itemSubjectRef="xsd:string"></dataObject>
  </process>
</definitions>