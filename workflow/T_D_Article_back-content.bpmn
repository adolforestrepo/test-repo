<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:activiti="http://activiti.org/bpmn"
             xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
             xmlns:jpdl2="urn:jbpm.org:jpdl-3.2"
             xmlns:jpdl1="urn:jbpm.org:jpdl-3.1"
             xmlns:xs="http://www.w3.org/2001/XMLSchema"
             xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL http://www.omg.org/spec/BPMN/2.0/20100501/BPMN20.xsd"
             targetNamespace="http://www.jbpm.org/"
             id="T_D_Article_back-content_Definitions"
             name="T_D_Article_back-content">
   <process isExecutable="true"
            id="T_D_Article_back-content_Process"
            name="T+D Article back-content">
            
            
            
      <startEvent name="StartNode" id="StartNode"/>
      
      
      <sequenceFlow sourceRef="StartNode" targetRef="Get_PID_and_Now_String"/>
      
      <endEvent name="EndNode" id="EndNode"/>
      
      
      <serviceTask id="DocX2XML_Transform" name="DocX2XML Transform"
                    activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectAstdDocxToXmlActionHandler">
			<activiti:field name="styleMapUri"
				              stringValue="rsuite:/res/plugin/astd-plugin/xslt/word2xml/article-style2tagmap.xml" />
			<activiti:field name="xsltUri"
				             stringValue="rsuite:/res/plugin/astd-plugin/xslt/word2xml/docx2article.xsl" />
			<activiti:field name="outputPath" stringValue="${exportDir}" />
			<activiti:field name="resultFileName" stringValue="${sourceFileName}.xml" />
			<activiti:field name="docxMoId" expression="${docxMoId}" />
			<activiti:field name="xsltGraphicRenameUri"
				stringValue="" />
			<activiti:field name="graphicsPrefix" stringValue="" />
		</serviceTask>
      <sequenceFlow id="fromdocX2XMLTransformToDecision" sourceRef="DocX2XML_Transform" targetRef="DOCX2XML_Error_"/>
      
      
      
      
      <serviceTask id="XML_to_INCX" name="XML to INCX"
                         activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectAstdXml2IncxActionHandler">
			<activiti:field name="styleCatalogUri"
				             stringValue="rsuite:/res/plugin/astd-plugin/xslt/newtpm2indesign/tpm-dita-indesign-style-catalog.xml" />
			<activiti:field name="xsltUriFromWorkflow"
				             stringValue="rsuite:/res/plugin/astd-plugin/xslt/newtpm2indesign/tpmArticle2InDesign.xsl" />
			<activiti:field name="fileName" stringValue="${sourceFileName}" />
			<activiti:field name="xmlMoId" stringValue="${xmlMoId}" />
		 </serviceTask>
      <sequenceFlow id="fromxMLToINCXToDecision" sourceRef="XML_to_INCX" targetRef="INX_Generation_Failure_"/>
      
     
      
      <serviceTask id="Load_INX" name="Load INX"
                   activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectLoadNonXmlByAliasHandler">
			<activiti:field name="alias" expression="${sourceFileName}.incx" />
			<activiti:field name="commitMessage" stringValue="Loaded by workflow" />
			<activiti:field name="parentMoId" expression="${articleCaMoId}" />
		</serviceTask>
     <sequenceFlow id="fromloadInxToDecision" sourceRef="Load_INX" targetRef="Have_No_Exec_Summary_"/>
      <exclusiveGateway id="Have_No_Exec_Summary_"/>
      <sequenceFlow sourceRef="Have_No_Exec_Summary_" targetRef="Load_Exec_Summary">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${empty incxExecSummaryFile == false]]></conditionExpression>
      </sequenceFlow>
      <sequenceFlow sourceRef="Have_No_Exec_Summary_" targetRef="Make_Article_CA_Current">
          <conditionExpression xsi:type="tFormalExpression"><![CDATA[${empty incxExecSummaryFile == true]]></conditionExpression>
      </sequenceFlow>
   
      
      <serviceTask id="Load_Exec_Summary" name="Load Exec Summary"
                         activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectLoadNonXmlByAliasHandler">
			<activiti:field name="alias" stringValue="${incxExecSummaryFile}" />
			<activiti:field name="fileToLoadFromWorkflow"
				             stringValue="${incxExecSummaryPath}" />
			<activiti:field name="commitMessage"
				             expression="Generated by ${rsuiteUserId} via workflow" />
			<activiti:field name="parentMoId"
				             stringValue="${articleCaMoId}" />
		</serviceTask>
      <sequenceFlow sourceRef="Load_Exec_Summary" targetRef="Make_Article_CA_Current"/>
      <userTask id="Final_Edit"
                name="Final Edit"
                activiti:candidateGroups="Managing Editor">
         <documentation>Document: ${fullFileName}</documentation>
      </userTask>
      <sequenceFlow sourceRef="Final_Edit" targetRef="Get_Tax"/>
      
      
      <serviceTask id="Load_DOCX" name="Load DOCX"
                  activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectLoadDocxActionHandler">
      </serviceTask>
      <sequenceFlow id="flowFromLoadDocxToValidationError" sourceRef="Load_DOCX" targetRef="DOCX_Load_Failed_"/>
      
      
      
      
      <serviceTask id="Create_CAs_for_DOCX" name="Create CAs for DOCX"
                    activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectCreateCAsActionHandler">
      </serviceTask>
      <sequenceFlow id="flowToSetLM" sourceRef="Create_CAs_for_DOCX" targetRef="Capture_Article_CA_MO_ID"/>
      
      
      
      <serviceTask id="Validate_File_Name" name="Validate File Parameters"
                   activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.AtdValidateFileNameActionHandler">
			<activiti:field name="allowedExtension" stringValue=".docx" />
			<activiti:field name="errorIfLocked" stringValue="true" />
			<activiti:field name="extensionErrorMessage"
				             stringValue="Only MS Word 2007 or later allowed. Please open in MS Word 2007 and save as a .docx file." />
			<activiti:field name="errorIfExits" stringValue="true" />
		 </serviceTask>

       <sequenceFlow id="flowToLoadErrorDecision" sourceRef="Validate_File_Name" targetRef="Are_there_validation_errors_"/>
       <exclusiveGateway id="Are_there_validation_errors_"/>
       <sequenceFlow sourceRef="Are_there_validation_errors_"
                    targetRef="Error_Alert_Article_Worfklow_Docx_Load_Failed">
          <conditionExpression xsi:type="tFormalExpression"><![CDATA[${VALIDATION_MSGS!=null == true]]></conditionExpression>
       </sequenceFlow>
       <sequenceFlow sourceRef="Are_there_validation_errors_" targetRef="Load_DOCX">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${VALIDATION_MSGS!=null == false]]></conditionExpression>
       </sequenceFlow>
       <userTask id="Error_Alert_Article_Worfklow_Docx_Load_Failed"
                name="Error Alert: Article Worfklow: Docx Load Failed"
                activiti:candidateGroups="Managing Editor">
          <documentation>${VALIDATION_MSGS}</documentation>
       </userTask>
       <sequenceFlow sourceRef="Error_Alert_Article_Worfklow_Docx_Load_Failed"
                     targetRef="EndNode"/>
       <exclusiveGateway id="Is_Unknown_DOCX_"/>
       <sequenceFlow sourceRef="Is_Unknown_DOCX_" targetRef="Create_CAs_for_DOCX">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${volumeNumber=='99' == false]]></conditionExpression>
       </sequenceFlow>
       <sequenceFlow sourceRef="Is_Unknown_DOCX_" targetRef="Create_CAs_for_unknown_DOCX">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${volumeNumber=='99' == true]]></conditionExpression>
       </sequenceFlow>
           
         
      <serviceTask id="Create_CAs_for_unknown_DOCX" name="Create_CAs_for_unknown_DOCX"
                   activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectCreateCAsActionHandler"/>
      <sequenceFlow sourceRef="Create_CAs_for_unknown_DOCX"
                    targetRef="Capture_Article_CA_MO_ID"/>
      <exclusiveGateway id="DOCX2XML_Error_"/>
      <sequenceFlow sourceRef="DOCX2XML_Error_"
                    targetRef="Error_Alert_Article_Workflow_Word_to_XML_Failed">
        <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==true == true]]></conditionExpression>
       </sequenceFlow>
       <sequenceFlow sourceRef="DOCX2XML_Error_" targetRef="Import_DITA">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==true == false]]></conditionExpression>
       </sequenceFlow>
       <userTask id="Error_Alert_Article_Workflow_Word_to_XML_Failed"
                 name="Error Alert: Article Workflow: Word to XML Failed"
                 activiti:candidateGroups="Managing Editor">
         <documentation>${moDisplayName}: Generation of XML from DOCX failed: ${exceptionMessage} &lt;br/&gt;See conversion report &lt;a href='/rsuite/rest/v1/report/generated/${xformReportId}?skey=RSUITE-SESSION-KEY' target='_xformReport'&gt;${xformReportFileName}&lt;a/&gt;</documentation>
       </userTask>
       <sequenceFlow sourceRef="Error_Alert_Article_Workflow_Word_to_XML_Failed"
                     targetRef="Clear_Load_Dita_Status"/>
       <exclusiveGateway id="INX_Generation_Failure_"/>
       <sequenceFlow sourceRef="INX_Generation_Failure_" targetRef="Load_INX">
          <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==true == false]]></conditionExpression>
       </sequenceFlow>
       <sequenceFlow sourceRef="INX_Generation_Failure_"
                     targetRef="Error_Alert_Article_Workflow_InCopy_Generation_Failed">
          <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==true == true]]></conditionExpression>
        </sequenceFlow>
      <userTask id="Error_Alert_Article_Workflow_InCopy_Generation_Failed"
                name="Error Alert: Article Workflow: InCopy Generation Failed"
                activiti:candidateGroups="Managing Editor">
         <documentation>Failed to generate INX from article ${fullFileName} &lt;br/&gt;See conversion report &lt;a href='/rsuite/rest/v1/report/generated/${xformReportId}?skey=RSUITE-SESSION-KEY' target='_xformReport'&gt;${xformReportFileName}&lt;a/&gt;</documentation>
      </userTask>
      <sequenceFlow sourceRef="Error_Alert_Article_Workflow_InCopy_Generation_Failed"
                    targetRef="gateway_Error_Alert_Article_Workflow_InCopy_Generation_Failed"/>
      <exclusiveGateway id="gateway_Error_Alert_Article_Workflow_InCopy_Generation_Failed"/>
      <sequenceFlow sourceRef="gateway_Error_Alert_Article_Workflow_InCopy_Generation_Failed"
                    targetRef="Final_Edit">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${target == "Final_Edit"}]]></conditionExpression>
      </sequenceFlow>
      <sequenceFlow sourceRef="gateway_Error_Alert_Article_Workflow_InCopy_Generation_Failed"
                    targetRef="EndNode">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${target == "EndNode"}]]></conditionExpression>
      </sequenceFlow>
      <exclusiveGateway id="DOCX_Load_Failed_"/>
      <sequenceFlow sourceRef="DOCX_Load_Failed_"
                    targetRef="Error_Alert_Article_Workflow_Docx_Load_Failed">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPOTION_OCCUR=='true' == true]]></conditionExpression>
      </sequenceFlow>
      <sequenceFlow sourceRef="DOCX_Load_Failed_" targetRef="Capture_DOCX_MO_ID">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPOTION_OCCUR=='true' == false]]></conditionExpression>
      </sequenceFlow>
      <userTask id="Error_Alert_Article_Workflow_Docx_Load_Failed"
                name="Error Alert: Article Workflow: Docx Load Failed"
                activiti:candidateGroups="Managing Editor">
         <documentation>Load of file ${fullFileName} failed: ${exceptionMessage}</documentation>
      </userTask>
      <sequenceFlow sourceRef="Error_Alert_Article_Workflow_Docx_Load_Failed"
                    targetRef="EndNode"/>
      <exclusiveGateway id="DITA_Load_Failed_"/>
      <sequenceFlow sourceRef="DITA_Load_Failed_"
                    targetRef="Error_Alert_Article_Workflow_XML_Load_Failed">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR=='true' == true]]></conditionExpression>
      </sequenceFlow>
      <sequenceFlow sourceRef="DITA_Load_Failed_" targetRef="Set_Tax">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR=='true' == false]]></conditionExpression>
      </sequenceFlow>
        <userTask id="Error_Alert_Article_Workflow_XML_Load_Failed"
                 name="Error Alert: Article Workflow: XML Load Failed"
                 activiti:candidateGroups="Managing Editor">
          <documentation>Load of DITA XML from DOCX ${fullFileName} failed: ${exceptionMessage}&lt;br/&gt;File also exported to ${sharedExportDir} &lt;br/&gt;See validation report &lt;a href='/rsuite/rest/v1/report/generated/${validationReportId}?skey=RSUITE-SESSION-KEY' target='_xformReport'&gt;${validationReportFileName}&lt;a/&gt;</documentation>
          </userTask>
       <sequenceFlow sourceRef="Error_Alert_Article_Workflow_XML_Load_Failed"
                    targetRef="Clear_Load_Dita_Status"/>
                    
             
                    
           <serviceTask id="Set_Variables_From_Properties" name="Ensure Map"
                     activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetGlobalVariablesActionHandler">
			 <activiti:field name="variableNames" stringValue="exportDir;sharedExportDir" />
			 <activiti:field name="values"
				stringValue="${astd.base.export.dir}${astd.xml.export.dir}/${pId};${astd.export.share}${astd.xml.export.dir}/${pId}" />
		 </serviceTask>
		
       <sequenceFlow id="fromSetVariablesToValidateFileName" sourceRef="Set_Variables_From_Properties"
                    targetRef="Validate_File_Name"/>
                    
                    
      <serviceTask id="Get_PID_and_Now_String" name="Set PID and Date Now"
                   activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetDynamicValuesToVariablesActionHandler">
                  <activiti:field name="variableNames" stringValue="pId;nowString" />
                 <activiti:field name="items" stringValue="pId;nowString" /></serviceTask>

      <sequenceFlow id="flowToSetVariablesFromProps" sourceRef="Get_PID_and_Now_String"
                    targetRef="Set_Variables_From_Properties"/>
                    
                    
      <serviceTask id="Capture_DOCX_MO_ID" name="Capture DOCX MO ID"
                   activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetVariableFromMoWorkflowListHandler"> 
			<activiti:field name="targetVariableName" stringValue="docxMoId"/></serviceTask>
         <sequenceFlow sourceRef="Capture_DOCX_MO_ID" targetRef="Is_Unknown_DOCX_"/>
      
      
      <serviceTask id="Capture_Article_CA_MO_ID"  name="Capture Article CA MO ID"
             activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetVariableFromMoWorkflowListHandler"> 
			<activiti:field name="targetVariableName" stringValue="${articleCaMoId}"/> 
			</serviceTask>
         <sequenceFlow sourceRef="Capture_Article_CA_MO_ID" targetRef="Set_Article_LM"/>
             
             
      
      <serviceTask id="Make_Article_CA_Current" name="Make Article CA Current"
                   activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetWorkflowMoListFromVariableHandler">
			    <activiti:field name="moSpecifyingVariableName"
				       stringValue="articleCaMoId" />
		</serviceTask>
       <sequenceFlow sourceRef="Make_Article_CA_Current" targetRef="EndNode"/>
                   
                   
      <serviceTask id="Import_DITA" name="Import DITA"
                  activiti:class="com.reallysi.rsuite.workflow.actions.TopicImporterActionHandler">
			<activiti:field name="topicPath"
				             stringValue="${exportDir}/${sourceFileName}/${sourceFileName}.xml" />
			<activiti:field name="parentCaId" stringValue="${articleCaMoId}" />
			<activiti:field name="commitMessage"
				             stringValue="Loaded via workflow from hotfolder" />
			<activiti:field name="importedMoListVarname"
				             stringValue="xmlMoId" />
			<activiti:field name="topicContainerName" stringValue="media" />
		</serviceTask>
      <sequenceFlow sourceRef="Import_DITA" targetRef="DITA_Load_Failed_"/>
      
      
      
      
      <serviceTask id="Set_Article_LM" name="Set Article LM"
                         activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectAddLayeredMetadataActionHandler">
			<activiti:field name="metadataName" stringValue="ca-type;article-process-id" />
			<activiti:field name="metadataValue" stringValue="article;${pId}" />
			<activiti:field name="moList" stringValue="${articleCaMoId}" />
		</serviceTask>
      <sequenceFlow sourceRef="Set_Article_LM" targetRef="Get_Tax"/>
      
      
      
      
      <serviceTask id="Clear_Load_Dita_Status" name="Clear Load Dita Status"
                   activiti:class="com.reallysi.rsuite.system.workflow.actions.ClearExceptionStatus">
		</serviceTask>
	   <sequenceFlow id="fromClearLoadDitaToFinalEditTask" sourceRef="Clear_Load_Dita_Status" targetRef="Final_Edit"/>
      
      
      
      <serviceTask id="Get_Tax" name="Get Tax"
                         activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectAtdSetClassificationVarActionHandler">
			<activiti:field name="moAlias" expression="${sourceFileName}.xml" />
			<activiti:field name="targetVariableName" stringValue="articleClassification" />
		</serviceTask>
      <sequenceFlow id="fromGetTaxToDocx2XmlTransform" sourceRef="Get_Tax" targetRef="DocX2XML_Transform"/>
      
      
      
      <serviceTask id="Set_Tax" name="Set Tax"
                   activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectAstdSetMoClassification">
			<activiti:field name="moAlias" stringValue="${sourceFileName}.xml" />
			<activiti:field name="data" stringValue="${articleClassification}" />
		</serviceTask>

      <sequenceFlow id="fromsetTaxToDecision" sourceRef="Set_Tax" targetRef="Set_Tax_Failed_"/>
      <exclusiveGateway id="Set_Tax_Failed_"/>
      <sequenceFlow sourceRef="Set_Tax_Failed_" targetRef="XML_to_INCX">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==true == false]]></conditionExpression>
      </sequenceFlow>
      <sequenceFlow sourceRef="Set_Tax_Failed_"
                    targetRef="Error_Alert_Article_Workflow_XML_Load_Failed">
         <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==true == true]]></conditionExpression>
      </sequenceFlow>
   </process>
</definitions>
