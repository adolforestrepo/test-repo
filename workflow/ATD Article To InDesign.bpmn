<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"
  xmlns:activiti="http://activiti.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
  typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath"
  targetNamespace="http://www.activiti.org/test">
  <process id="ATD Article To InDesign" name="ATD Article To InDesign" isExecutable="true">
    <startEvent id="startWorkflow" name="Start"/>

    <sequenceFlow id="flowToSetParentCANodetoVariable" sourceRef="startWorkflow" targetRef="setParentCANodetoVariable"/>

    <serviceTask id="setParentCANodetoVariable" name="Set Parent CA Node to Variable" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetParentBrowseTreeNodeToVariableHandler">
      <activiti:field name="variableName" stringValue="parentMoId"/>
    </serviceTask>

    <sequenceFlow id="flowFromSetParentCAToSetVariables" sourceRef="setParentCANodetoVariable" targetRef="setVariablesfromProperties"/>
    
    <serviceTask id="setVariablesfromProperties" name="Set Variables from Properties" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectSetGlobalVariablesActionHandler">
      <activiti:field name="variableNames" stringValue="exportDir;sharedExportDir" />
      <activiti:field name="values" stringValue="${astd.base.export.dir}${astd.incx.export.dir}/${rsuiteUserId};${astd.export.share}${astd.incx.export.dir}/${rsuiteUserId}" />
    </serviceTask>

    <sequenceFlow id="flowFromSetVariablesToSetMODetails" sourceRef="setVariablesfromProperties" targetRef="setMODetailstoVariables"/>
    
    <serviceTask id="setMODetailstoVariables" name="Set MO Details to Variables" activiti:class="com.reallysi.rsuite.system.workflow.actions.SetVariablesFromMoDetails">
    </serviceTask>


    <sequenceFlow id="flowFromsetMODetailstoxMLToINCX" sourceRef="setMODetailstoVariables" targetRef="xMLToINCX"></sequenceFlow>



    <serviceTask id="xMLToINCX" name="XML to INCX" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectAstdXml2IcmlActionHandler">
            <activiti:field name="styleCatalogUri" stringValue="rsuite:/res/plugin/astd-plugin/xslt/tandd2indesign/tandd-dita-indesign-style-catalog.xml" />
            <activiti:field name="xsltUriFromWorkflow" stringValue="rsuite:/res/plugin/astd-plugin/xslt/tandd2indesign/tanddArticle2InDesign.xsl" />
            <activiti:field name="outputPath" stringValue="${exportDir}" />
            <activiti:field name="fileName" stringValue="${moBaseName}" />
            <activiti:field name="xmlMoId" stringValue="${rsuite contents}" />
    </serviceTask>


        <sequenceFlow id="fromxMLToINCXToDecision" sourceRef="xMLToINCX" targetRef="determineXml2INCXError"></sequenceFlow>

        <exclusiveGateway id="determineXml2INCXError" name="InCopy Generation Failure?"></exclusiveGateway>

        <sequenceFlow id="flowToXML2INXError" sourceRef="determineXml2INCXError" targetRef="xml2INCXError">
                <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==true}]]></conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowToLoadINX" sourceRef="determineXml2INCXError" targetRef="loadInx">
                <conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==false}]]></conditionExpression>
        </sequenceFlow>

        <userTask id="xml2INCXError" name="InCopy Generation Failed" activiti:assignee="${rsuiteUserId}" activiti:candidateGroups="RSuiteAdministrator">
                <documentation>"#{moDisplayName}: InCopy generation failed: #{exceptionMessage} &lt;br/&gt;See conversion report &lt;a href='/rsuite/rest/v1/report/generated/#{xformReportId}?skey=RSUITE-SESSION-KEY' target='_xformReport'&gt;#{xformReportFileName}&lt;a/&gt;"
                </documentation>
        </userTask>
        
        <sequenceFlow id="fromxml2INCXErrortoendWorkflow" sourceRef="xml2INCXError" targetRef="endWorkflow"/>
        <sequenceFlow id="fromINCXGenerationFailedtoClearExceptionStatus" sourceRef="xml2INCXError" targetRef="ClearExceptionStatus"/>

       <serviceTask id="ClearExceptionStatus" name="Clear Exception Status" activiti:class="com.reallysi.rsuite.system.workflow.actions.ClearExceptionStatus">
       </serviceTask>

      <sequenceFlow id="flowFromClearExceptionStatusToDOCXtoDITA" sourceRef="ClearExceptionStatus" targetRef="xMLToINCX"/>


        <serviceTask id="loadInx" name="Load INX" activiti:class="org.astd.rsuite.workflow.actions.leaving.rsuite5.ProjectLoadNonXmlByAliasHandler">
				<activiti:field name="alias" stringValue="${moBaseName}.icml" />
				<activiti:field name="fileToLoadFromWorkflow" stringValue="${exportDir}/${moBaseName}.icml" />
				<activiti:field name="commitMessage" stringValue="Generated by user ${rsuiteUserId}" />
                <activiti:field name="parentMoId" expression="${parentMoId}" />
        </serviceTask>

        <sequenceFlow id="fromloadInxToDecision" sourceRef="loadInx" targetRef="determineloadInxFailed"></sequenceFlow>

        <exclusiveGateway id="determineloadInxFailed" name="Exception on Load INX?"></exclusiveGateway>

	<sequenceFlow id="flowToLoadTheXmlError" sourceRef="determineloadInxFailed" targetRef="LoadofINXFailed">
		<conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==true}]]></conditionExpression>
	</sequenceFlow>

	<sequenceFlow id="flowxmlGenerated" sourceRef="determineloadInxFailed" targetRef="INXGenerated">
		<conditionExpression xsi:type="tFormalExpression"><![CDATA[${EXCEPTION_OCCUR==false}]]></conditionExpression>
	</sequenceFlow>
	
	<userTask id="LoadofINXFailed" name="Load of InCopy Failed" activiti:assignee="${rsuiteUserId}" activiti:candidateGroups="RSuiteAdministrator">
	  <documentation>"#{moDisplayName}: Load of generated InCopy file failed: #{exceptionMessage} &lt;br/&gt;File exported to #{sharedExportDir};"</documentation>
	  <extensionElements>
	    <activiti:taskListener event="create" class="com.reallysi.rsuite.system.workflow.actions.taskcreate.AssignTaskToUserFromVariable"></activiti:taskListener>
	  </extensionElements>
	</userTask>
	
	<sequenceFlow id="fromLoadofINXFailedtoendWorkflow" sourceRef="LoadofINXFailed" targetRef="endWorkflow"/>
	<sequenceFlow id="fromLoadofINXFailedtoClearExceptionStatus" sourceRef="LoadofINXFailed" targetRef="ClearExceptionStatus"/>
	
	<userTask id="INXGenerated" name="InCopy Generated">
	  <documentation>"#{moDisplayName}: InCopy article generated and updated in RSuite. &lt;br/&gt;File also exported to #{sharedExportDir} &lt;br/&gt;See conversion report &lt;a href='/rsuite/rest/v1/report/generated/#{xformReportId}?skey=RSUITE-SESSION-KEY' target='_xformReport'&gt;#{xformReportFileName}&lt;a/&gt;"</documentation>
	  <extensionElements>
	    <activiti:taskListener event="create" class="com.reallysi.rsuite.system.workflow.actions.taskcreate.AssignTaskToUserFromVariable"></activiti:taskListener>
	  </extensionElements>
	</userTask>

	<sequenceFlow id="fromINXGeneratedtoendWorkflow" sourceRef="INXGenerated" targetRef="endWorkflow"/>


    <endEvent id="endWorkflow" name="End Workflow"></endEvent>
    <dataObject id="EXCEPTION_OCCUR" name="EXCEPTION_OCCUR" itemSubjectRef="xsd:string">
      <extensionElements>
        <activiti:value>""</activiti:value>
      </extensionElements>
    </dataObject>
    <dataObject id="rsuiteUserId" name="rsuiteUserId" itemSubjectRef="xsd:string"></dataObject>
  </process>
</definitions>